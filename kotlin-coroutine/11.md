# 11ì¥ ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜

ì—¬ëŸ¬ ê°œì˜ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ë°ì´í„°ë¥¼ ë™ì‹œì— ì–»ì–´ì•¼ í•˜ëŠ” ì¤‘ë‹¨í•¨ìˆ˜ëŠ” ì–´ë–»ê²Œ êµ¬í˜„í•´ì•¼í• ê¹Œ?

## ì½”ë£¨í‹´ ìŠ¤ì½”í”„ ì†Œê°œ ì´ì „ì— ì‚¬ìš©í•œ ë°©ë²•ë“¤

#### ë°©ë²• 1) ì¤‘ë‹¨ í•¨ìˆ˜ì—ì„œ ì¤‘ë‹¨í•¨ìˆ˜ í˜¸ì¶œí•˜ê¸°

* ë¬¸ì œ - ì‘ì—…ì´ ë™ì‹œì— ì§„í–‰ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ 1ì´ˆ + 1ì´ˆ = 2ì´ˆë‚˜ ê±¸ë¦¼

```kotlin
suspend fun getUserProfile(): UserProfileData {
    val user = getUserData()                // (1ì´ˆ í›„)
    val notifications = getNotifications() // (1ì´ˆ í›„)
    
    return UserProfileData(
        user = user,
        notifications = notifications
    )
}
```

#### ë°©ë²• 2) ë™ì‹œ ì‘ì—…ì„ ìœ„í•´ async ë¡œ ë˜í•‘í•˜ê¸°

`async` ëŠ” ìŠ¤ì½”í”„ë‚´ì—ì„œ í˜¸ì¶œë˜ì–´ì•¼ í•œë‹¤,, í•˜ì§€ë§Œ ê·¸ë ‡ë‹¤ê³  `GlobalScope`ë¥¼ ì‚¬ìš©í•˜ë©´ ì•ˆëœë‹¤

```kotlin
// ì´ë ‡ê²Œ êµ¬í˜„í•˜ë©´ ì•ˆë¼!
suspend fun getUserProfile(): UserProfileData {
    val user = GlobalScope.async { getUserData() }              
    val notifications = GlobalScope.async { getNotifications() }
    
    return UserProfileData(
        user = user.await(),
        notifications = notifications.await()
    )
}
```

GlobalScopeëŠ” EmptyCoroutineContextë¥¼ ê°€ì§„ ìŠ¤ì½”í”„ ì¼ ë¿ì´ë¯€ë¡œ, ë‚´ë¶€ì—ì„œ asyncë¥¼ í˜¸ì¶œí•˜ë©´ ëª‡ëª‡ ë¬¸ì œê°€ ìƒê¸¸ ìˆ˜ ìˆë‹¤

* ë¬¸ì œ
  * asyncê°€ ë¶€ëª¨ ì½”ë£¨í‹´ê³¼ ì•„ë¬´ëŸ° ê´€ê³„ê°€ ì—†ì–´ì§€ë¯€ë¡œ ì·¨ì†Œë  ìˆ˜ ì—†ë‹¤ (ë¶€ëª¨ê°€ ì·¨ì†Œë˜ì–´ë„ async ë‚´ë¶€ í•¨ìˆ˜ëŠ” ì—¬ì „íˆ ì‹¤í–‰ ì¤‘ì¸ ìƒíƒœê°€ ë¨)
  * ë¶€ëª¨ ì½”ë£¨í‹´ìœ¼ë¡œë¶€í„° ìŠ¤ì½”í”„ë¥¼ ìƒì†ë°›ì§€ ì•Šê³  ê¸°ë³¸ ë””ìŠ¤íŒ¨ì²˜ì—ì„œ ì‹¤í–‰ë˜ë©°, ë¶€ëª¨ì˜ ì»¨í…ìŠ¤íŠ¸ì™€ ì „í˜€ ì—°ê´€ì´ ì—†ë‹¤
  * ì¦‰, ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ê°€ ë°œìƒí•  ìˆ˜ ìˆê³  & í…ŒìŠ¤íŠ¸í•˜ê¸°ë„ ì–´ë ¤ì›Œì§„ë‹¤

```kotlin
public object GlobalScope : CoroutineScope {
    override val coroutineContext: CoroutineContext
        get() = EmptyCoroutineContext
}

public object EmptyCoroutineContext : CoroutineContext, Serializable {
    private const val serialVersionUID: Long = 0
    private fun readResolve(): Any = EmptyCoroutineContext

    public override fun <E : Element> get(key: Key<E>): E? = null
    public override fun <R> fold(initial: R, operation: (R, Element) -> R): R = initial
    public override fun plus(context: CoroutineContext): CoroutineContext = context
    public override fun minusKey(key: Key<*>): CoroutineContext = this
    public override fun hashCode(): Int = 0
    public override fun toString(): String = "EmptyCoroutineContext"
}
```

#### ë°©ë²• 3) ìŠ¤ì½”í”„ë¥¼ ì¸ìë¡œ ë„˜ê¸°ê¸°

* ì¥ì  - ì·¨ì†Œê°€ ê°€ëŠ¥í•˜ê³  ì ì ˆí•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤
* ë¬¸ì œ - ìŠ¤ì½”í”„ê°€ í•¨ìˆ˜ì—ì„œ í•¨ìˆ˜ë¡œ ì „ë‹¬ë˜ë©´ì„œ ì˜ˆìƒí•˜ì§€ ëª»í•œ ë¶€ì‘ìš©ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤,,, ì ì¬ì ìœ¼ë¡œ ìœ„í—˜!
  * asyncì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ëª¨ë“  ìŠ¤ì½”í”„ê°€ ë‹«í ìˆ˜ë„ ìˆìŒ (SupervisorJobì´ ì•„ë‹Œ ê²½ìš°)
  * ìŠ¤ì½”í”„ì— ì ‘ê·¼í•˜ëŠ” í•¨ìˆ˜ê°€ cancel ë©”ì„œë“œë¡œ ìŠ¤ì½”í”„ë¥¼ ì·¨ì†Œí•˜ëŠ” ë“± ìŠ¤ì½”í”„ë¥¼ ì¡°ì‘í•  ìˆ˜ë„ ìˆìŒ

```kotlin
// ì´ë ‡ê²Œ êµ¬í˜„í•˜ë©´ ì•ˆë¼!
suspend fun getUserProfile(
    scope: CoroutineScope
): UserProfileData {
    val user = scope.async { getUserData() }              
    val notifications = scope.async { getNotifications() }
    
    return UserProfileData(
        user = user.await(),
        notifications = notifications.await()
    )
}

// ì´ê²ƒë„ ì•ˆë¼!
suspend fun CoroutineScope.getUserProfile(): UserProfileData {
    val user = async { getUserData() }              
    val notifications = async { getNotifications() }
    
    return UserProfileData(
        user = user.await(),
        notifications = notifications.await()
    )
}
```

* ì˜ëª» êµ¬í˜„í•œ ì˜ˆì œ

```kotlin
data class Details(val name: String, val followers: Int)
data class Tweet(val text: String)

fun getFollowersNumber(): Int =
    throw Error("Service exception")
    
suspend fun getUserName(): String {
    delay(500)
    return "chaeeun"
}

suspend fun getTweets(): List<Tweet> {
    return listOf(Tweet("Hello, world"))
}

// ì˜ëª»ëœ êµ¬í˜„ ë°©ë²•!
// Ambiguous coroutineContext due to CoroutineScope receiver of suspend function 
suspend fun CoroutineScope.getUserDetails(): Details {
    val userName = async { getUserName() }
    val followersNumber = async { getFollowersNumber() }
    return Details(userName.await(), followersNumber.await())
}

fun main() = runBlocking {
    val details = try {
        getUserDetails() // ë°œìƒí•œ ì˜ˆì™¸ê°€ í•´ë‹¹ asyncë¥¼ ì¢…ë£Œ, ì „ì²´ ìŠ¤ì½”í”„ ì¢…ë£Œë¡œ ì´ì–´ì§
    } catch (e: Error) {
        null
    }
    
    val tweets = async { getTweets() } // ì „ì²´ ìŠ¤ì½”í”„ ì¢…ë£Œë˜ì–´ ë™ì‘ ì•ˆí•¨
    println("User: $details")
    println("Tweets: ${tweets.await()}")
}

// ì˜ˆì™¸ë§Œ ë°œìƒ
```

## coroutineScope

ìŠ¤ì½”í”„ë¥¼ ì‹œì‘í•˜ëŠ” ì¤‘ë‹¨ í•¨ìˆ˜, ì¸ìë¡œ ë“¤ì–´ì˜¨ í•¨ìˆ˜ê°€ ìƒì„±í•œ ê°’ì„ ë°˜í™˜í•œë‹¤

```kotlin
suspend fun <R> coroutineScope(block: suspend CoroutineScope.() -> R): R
```

* asyncë‚˜ launchì™€ ë‹¤ë¥´ê²Œ coroutineScopeì˜ ë³¸ì²´ëŠ” ë¦¬ì‹œë²„ì—†ì´ ê³§ë°”ë¡œ í˜¸ì¶œë¨
* ìƒˆë¡œìš´ ì½”ë£¨í‹´ì„ ìƒì„±, ìƒˆë¡œìš´ ì½”ë£¨í‹´ì´ ëë‚  ë•Œ ê¹Œì§€ coroutineScopeë¥¼ í˜¸ì¶œí•œ ì½”ë£¨í‹´ì„ ì¤‘ë‹¨í•œë‹¤
  * ê¸°ì¡´ì˜ ì¤‘ë‹¨ ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë²—ì–´ë‚œ ìƒˆë¡œìš´ ìŠ¤ì½”í”„ > ë¶€ëª¨ë¡œë¶€í„° ìƒì†ë°›ê³  êµ¬ì¡°í™”ëœ ë™ì‹œì„±ì„ ì§€
* ìƒì„±ëœ ìŠ¤ì½”í”„ëŠ” ë°”ê¹¥ì˜ ìŠ¤ì½”í”„ì—ì„œ coroutineContextë¥¼ ìƒì†ë°›ì§€ë§Œ, ì»¨í…ìŠ¤íŠ¸ì˜ Jobì„ ì˜¤ë²„ë¼ì´ë”©í•œë‹¤
  * ë¶€ëª¨ë¡œ ë¶€í„° ì»¨í…ìŠ¤íŠ¸ë¥¼ ìƒì†ë°›ìŒ
  * ìì‹ ì˜ ì‘ì—…ì„ ëë‚´ê¸° ì „ê¹Œì§€ ëª¨ë“  ìì‹ì„ ê¸°ë‹¤ë¦¼
  * ë¶€ëª¨ê°€ ì·¨ì†Œë˜ë©´ ìì‹ë“¤ ëª¨ë‘ë¥¼ ì·¨ì†Œí•¨

```kotlin
fun main() = runBlocking {   
    val a = coroutineScope { 
        delay(1000)
        10
    }
    println("a is caculated")
    val b = coroutineScope {
        delay(1000)
        20
    }
    println(a) // 10
    println(b) // 20
}

// (1ì´ˆ í›„)
// a is calculated
// (1ì´ˆ í›„)
// 10
// 20
```

#### coroutineContextê°€ ìƒì†ë˜ê³ , coroutineScopeëŠ” ëª¨ë“  ìì‹ì´ ëë‚  ë•Œê¹Œì§€ ì¢…ë£Œë˜ì§€ ì•ŠëŠ”ë‹¤

```kotlin
suspend fun longTask() = coroutineScope {
    launch {
        delay(1000)
        val name = coroutineContext[CoroutineName]?.name
        println("[$name] Finished task 1")
    }
    
    launch {
        delay(2000)
        val name = coroutineContext[CoroutineName]?.name
        println("[$name] Finished task 2")
    }
}

fun main() = runBlocking(CoroutineName("Parent")) {
    println("Before")
    longTask() // coroutineScopeë¥¼ í˜¸ì¶œí•œ ì½”ë£¨í‹´ì€ ì¤‘ë‹¨ë˜ë¯€ë¡œ, ì‘ì—…ì´ ëë‚˜ê³  ë‚˜ì„œì•¼ After ì¶œë ¥ë¨
    println("After")
}

// Before
// (1ì´ˆ í›„)
// [Parent] Finished task 1
// (1ì´ˆ í›„)
// [Parent] Finished task 2
// After
```

#### ë¶€ëª¨ê°€ ì·¨ì†Œë˜ë©´ ì•„ì§ ëë‚˜ì§€ ì•Šì€ ìì‹ ì½”ë£¨í‹´ë„ ì „ë¶€ ì·¨ì†Œë¨

```kotlin
suspend fun longTask() = coroutineScope {
    launch {
        delay(1000)
        val name = coroutineContext[CoroutineName]?.name
        println("[$name] Finished task 1")
    }
    
    launch {
        delay(2000)
        val name = coroutineContext[CoroutineName]?.name
        println("[$name] Finished task 2")
    }
}

fun main() = runBlocking {
    val job = launch(CoroutineName("Parent")) {
        longTask()
    }
    delay(1500)
    job.cancel() // ë¶€ëª¨ ì·¨ì†Œ
}

// [Parent] Finished task 1
```

#### ì½”ë£¨í‹´ ë¹Œë”ì™€ ë‹¬ë¦¬ coroutineScopeë‚˜ ìŠ¤ì½”í”„ì— ì†í•œ ìì‹ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´, ë‹¤ë¥¸ ëª¨ë“  ìì‹ì´ ì·¨ì†Œë˜ê³  ì˜ˆì™¸ê°€ ë‹¤ì‹œ ë˜ì ¸ì§„ë‹¤

```kotlin
data class Details(val name: String, val followers: Int)
data class Tweet(val text: String)

fun getFollowersNumber(): Int =
    throw Error("Service exception")
    
suspend fun getUserName(): String {
    delay(500)
    return "chaeeun"
}

suspend fun getTweets(): List<Tweet> {
    return listOf(Tweet("Hello, world"))
}

// ìœ„ ì˜ëª»ëœ êµ¬í˜„ ì˜ˆì‹œì˜ í•´ê²° ë°©ë²•
suspend fun getUserDetails(): Details = coroutineScope {
    val userName = async { getUserName() } // ì˜ˆì™¸ ë°œìƒ, í•´ë‹¹ ìŠ¤ì½”í”„ì— ì†í•œ ìì‹ë“¤ ëª¨ë‘ ì·¨ì†Œ, ì˜ˆì™¸ ë‹¤ì‹œ ë˜ì ¸ì§
    val followersNumber = async { getFollowersNumber() } // ì·¨ì†Œë¨
    return@coroutineScope Details(userName.await(), followersNumber.await())
    // return@ - https://kotlinlang.org/docs/returns.html
}

fun main() = runBlocking {
    val details = try {
        getUserDetails()
    } catch (e: Error) {
        println("Error : $e")
        null
    }
    
    val tweets = async { getTweets() }
    println("User: $details")
    println("Tweets: ${tweets.await()}")
}

// Error : java.lang.Error: Service exception
// User: null
// Tweets: [Tweet(text=Hello, world)]
```

#### ë³‘ë ¬ ì‘ì—… ìˆ˜í–‰&#x20;

```kotlin
suspend fun getUserProfile(): UserProfileData = 
    coroutineScope {
        val user = async { getUserData() }
        val notifications = async { getNotifications() }
        
        UserProfileData(
            user = user.await(),
            notifications = notifications.await()
        )
    }
```

#### ì¤‘ë‹¨ ë©”ì¸ í•¨ìˆ˜ë¥¼ ë˜í•‘í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©ë¨ (runBlocking ëŒ€ì‹ !)

```kotlin
suspend fun main() = coroutineScope {
    launch {
        delay(1000)
        println("World")
    }
    println("Hello,")
}

// Hello,
// (1ì´ˆ í›„)
// World
```

## ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜

ì¤‘ë‹¨ í•¨ìˆ˜ì—ì„œ ì½”ë£¨í‹´ ìŠ¤ì½”í”„ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ì¤‘ë‹¨ í•¨ìˆ˜ë¡œ, ëŒë‹¤ì‹ ì „ì²´ë¥¼ ë˜í•‘í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©í•œë‹¤

| ì½”ë£¨í‹´ ë¹Œë” (runBlocking ì œì™¸)          | ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜                                                   |
| -------------------------------- | ------------------------------------------------------------ |
| launch / async / produce         | coroutineScope / supervisorScope / withContext / withTimeout |
| CoroutineScopeì˜ í™•ì¥ í•¨ìˆ˜            | ì¤‘ë‹¨ í•¨ìˆ˜                                                        |
| CoroutineScope ë¦¬ì‹œë²„ì˜ ì½”ë£¨í‹´ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš© | ì¤‘ë‹¨ í•¨ìˆ˜ì˜ Continuation ê°ì²´ê°€ ê°€ì§„ ì½”ë£¨í‹´ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©                      |
| ì˜ˆì™¸ëŠ” Jobì„ í†µí•´ ë¶€ëª¨ë¡œ ì „íŒŒë¨              | ì¼ë°˜ í•¨ìˆ˜ì™€ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ì˜ˆì™¸ë¥¼ ë˜ì§                                        |
| ë¹„ë™ê¸°ì¸ ì½”ë£¨í‹´ì„ ì‹œì‘í•¨                    | ì½”ë£¨í‹´ ë¹Œë”ê°€ í˜¸ì¶œëœ ê³³ì—ì„œ ì½”ë£¨í‹´ì„ ì‹œì‘í•¨                                     |

* runBlockingì€ íŠ¹ìˆ˜í•œ ì½”ë£¨í‹´ ë¹Œë”ë¡œ, ì½”ë£¨í‹´ ê³„ì¸µ ì¤‘ ê°€ì¥ ìƒìœ„ì— ìˆëŠ” ë¸”ë¡œí‚¹ í•¨ìˆ˜ (ì½”ë£¨í‹´ ìŠ¤ì½”í”„ëŠ” ê³„ì¸µ ì¤‘ê°„)

### withContext

coroutineScopeì™€ ë¹„ìŠ· BUT ìŠ¤ì½”í”„ì˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë‹¤

* withContextì˜ ì¸ìë¡œ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì œê³µí•˜ë©´ ì½”ë£¨í‹´ ë¹Œë”ì™€ ê°™ì€ ë°©ì‹ìœ¼ë¡œ, ë¶€ëª¨ ìŠ¤ì½”í”„ì˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ëŒ€ì²´í•œë‹¤

```kotlin
fun CoroutineScope.log(text: String) {
    val name = this.coroutineContext[CoroutineName]?.name
    println("[$name] $text")
}

fun main() = runBlocking(CoroutineName("Parent")) {
    log("Before")
    
    withContext(CoroutineName("Child1")) { // ì»¨í…ìŠ¤íŠ¸ ë³€ê²½
        delay(1000)
        log("Hello 1")
    }
    
    withContext(CoroutineName("Child2")) { // ì»¨í…ìŠ¤íŠ¸ ë³€ê²½
        delay(1000)
        log("Hello 2")
    }
    
    log("After")
}

// [Parent] Before
// (1ì´ˆ í›„)
// [Child1] Hello 1
// (1ì´ˆ í›„)
// [Child2] Hello 2
// [Parent] After
```

* ê¸°ì¡´ ìŠ¤ì½”í”„ì™€ ì»¨í…ìŠ¤íŠ¸ê°€ ë‹¤ë¥¸ ì½”ë£¨í‹´ ìŠ¤ì½”í”„ë¥¼ ì„¤ì •í•˜ê¸° ìœ„í•´ ì£¼ë¡œ ì‚¬ìš©ëœë‹¤(w. ë””ìŠ¤íŒ¨ì²˜Dispatchers)

```kotlin
launch(Dispatchers.Main) {
    view.showProgressBar()
    withContext(Dispatchers.IO) {
        fileRepository.saveData(data)
    }
    view.hideProgressBar()
}
```

### supervisorScope

Jobì„ SupervisorJobìœ¼ë¡œ ì˜¤ë²„ë¼ì´ë”©í•œ coroutineScope

#### ìì‹ ì½”ë£¨í‹´ì´ ì˜ˆì™¸ë¥¼ ë˜ì§€ë”ë¼ë„ ì·¨ì†Œë˜ì§€ ì•ŠëŠ”ë‹¤

```kotlin
fun main() = runBlocking {
    println("Before")
    
    supervisorScope {
        launch {
            delay(1000)
            throw Error() // ì˜ˆì™¸ ë°œìƒ, ë¶€ëª¨ì—ê²Œ ì˜ˆì™¸ ì „íŒŒ ì·¨ì†Œ > supervisorScopeë¼ ì „íŒŒ ì•ˆë¨
        }
        
        launch {
            delay(2000)
            println("Done")
        }
    }
    
    println("After")
}

// Before
// (1ì´ˆ í›„)
// ì˜ˆì™¸ ë°œìƒ
// (1ì´ˆ í›„)
// Done
// After
```

#### ì„œë¡œ ë…ë¦½ì ì¸ ì‘ì—…ì„ ì‹œì‘í•˜ëŠ” í•¨ìˆ˜ì—ì„œ ì£¼ë¡œ ì‚¬ìš©í•¨

```kotlin
suspend fun notifyAnanlytics(actions: List<UserAction>) = 
    supervisorScope {
        actions.forEach { action ->
            launch {
                notifyAnalytics(action) // ? ì¬ê·€ ?
            }
        }
    }
```

#### asyncë¥¼ ì‚¬ìš©í•  ê²½ìš°, ì˜ˆì™¸ê°€ ë¶€ëª¨ë¡œ ì „íŒŒë˜ëŠ” ê²ƒì„ ë§‰ëŠ” ê²ƒ ì™¸ì— ì¶”ê°€ì ì¸ ì˜ˆì™¸ ì²˜ë¦¬ê°€ í•„ìš”í•˜ë‹¤

```kotlin
class ArticlesRepositoryComposite(
    private val articleRepositories: List<ArticleRepository>
): ArticeRepository {
    override suspend fun fetchArticles(): List<Article> = 
        supervisorScope {
            articleRepositories
                .map { async { it.fetchArticles() } }
                .mapNotNull {
                    try {
                        it.await() // await í˜¸ì¶œì„ try-catchë¡œ ë˜í•‘í•´ì„œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬
                    } catch (e: Throwable) {
                        e.printStackTrace()
                        null
                    }
                }
                .flatten()
                .sortedByDescending { it.publishedAt }
        }
}
```

#### withContext(SupervisorJob()) ì‚¬ìš©í•˜ì§€ ì•Šê¸°!!

* withContextëŠ” ì—¬ì „íˆ ê¸°ì¡´ì— ê°€ì§€ê³  ìˆë˜ Jobì„ ì‚¬ìš©í•˜ê³ , SupervisorJob()ì´ í•´ë‹¹ Jobì˜ ë¶€ëª¨ê°€ ë¨ > ë”°ë¼ì„œ SupervisorJobì˜ ìì‹ì€ withContext Job í•˜ë‚˜ë§Œ í•´ë‹¹
* withContext ë‚´ ìì‹ ì½”ë£¨í‹´ì˜ ë¶€ëª¨ëŠ” SupervisorJobì´ ì•„ë‹Œ ì…ˆì´ ë˜ë¯€ë¡œ, ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œ ë‹¤ë¥¸ ì½”ë£¨í‹´ì—ë„ ì˜ˆì™¸ê°€ ì „íŒŒë˜ì–´ ì·¨ì†Œë¨

```kotlin
fun main() = runBlocking {
    println("Before")
    
    withContext(SupervisorJob()) {
        launch {
            delay(1000)
            throw Error
        }
        
        launch {
            delay(2000)
            println("Done")
        }
    }
    
    println("After")
}

// Before
// (1ì´ˆ í›„)
// After
```

### withTimeout

timeout ê°’ì„ ì¸ìë¡œ ë°›ëŠ” coroutineScope

#### ì‹¤í–‰ì´ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦¬ë©´ ëŒë‹¤ì‹ì€ ì·¨ì†Œë˜ê³ , `TimeoutCancellationException`ì„ ë˜ì§„ë‹¤

```kotlin
suspend fun test() = withTimeout(1500) {
    delay(1000)
    println("Still thinking,,,")
    delay(1000)
    println("Done!")
    42
}

suspend fun main() = coroutineScope {
    try {
        test() // withTimeout ì œí•œ ì‹œê°„ì„ ë„˜ê²¨ì„œ ì˜ˆì™¸ ë˜ì§
    } catch (e: TimeoutCancellationException) {
        println("Cancelled")
    }
    delay(1000) // ? test()ê°€ ì·¨ì†Œë˜ì—ˆê¸° ë•Œë¬¸ì— íƒ€ì„ì•„ì›ƒ ì‹œê°„ì„ ëŠ˜ë ¤ë„ ì•„ë¬´ëŸ° ë„ì›€ ì•ˆë¨
}

// (1ì´ˆ í›„)
// Still thinking,,,
// (0.5ì´ˆ í›„)
// Cancelled
```

#### í…ŒìŠ¤íŠ¸í•  ë•Œ ìœ ìš©

> runTest
>
> [https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-test/kotlinx.coroutines.test/run-test.html](https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-test/kotlinx.coroutines.test/run-test.html)
>
> ```kotlin
> dependencies {
>     testImplementation "org.jetbrains.kotlinx:kotlinx-coroutines-test:$coroutines_version"
> }
> ```

```kotlin
class CoroutineTest {
    @OptIn(ExperimentalCoroutinesApi::class)
    @Test
    fun testTime2() = runTest {
        withTimeout(1000) {
            delay(900) // runTest ë‚´ë¶€ì—ì„œëŠ” ê°€ìƒ ì‹œê°„ìœ¼ë¡œ ì‘ë™ (ì‹¤ì œë¡œ 900msê¸°ë‹¤ë¦¬ì§€ëŠ” ì•ŠìŒ)
        }
    }

    @OptIn(ExperimentalCoroutinesApi::class)
    @Test(expected = TimeoutCancellationException::class)
    fun testTime1() = runTest {
        withTimeout(1000) {
            delay(1100)
        }
    }

    @Test
    fun testTime3() = runBlocking {
        withTimeout(1000) {
            delay(900) // ì‹¤ì œë¡œ 900ms ê¸°ë‹¤ë¦¼
        }
    }
}
```

#### TimeoutCancellationException ì˜ˆì™¸ëŠ” ë¶€ëª¨ì—ê²Œ ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŒ

* TimeoutCancellationExceptionì€ CancellatinExceptionì˜ ì„œë¸Œíƒ€ì…
* ì˜ˆì™¸ê°€ CancellationExceptionì˜ ì„œë¸Œí´ë˜ìŠ¤ë¼ë©´ ë¶€ëª¨ë¡œ ì „íŒŒë˜ì§€ ì•Šê³  í˜„ì¬ ì½”ë£¨í‹´ë§Œ ì·¨ì†Œí•œë‹¤ (10ì¥ ì˜ˆì™¸ ì²˜ë¦¬ ì°¸ê³ )

```kotlin
suspend fun main() = coroutineScope {
    launch { // ì·¨ì†Œë¨
        launch { // ë¶€ëª¨ì— ì˜í•´ ì·¨ì†Œë¨
            delay(2000)
            println("will not be printed")
        }
        
        withTimeout(1000) {
            delay(1500) // ì œí•œ ì‹œê°„ë³´ë‹¤ ì˜¤ë˜ê±¸ë¦¬ë¯€ë¡œ ì˜ˆì™¸ ë˜ì§
        }
    }
    
    launch { // ì˜í–¥ ì—†ìŒ
        delay(2000)
        println("Done")
    }
}

// (2ì´ˆ í›„)
// Done
```

#### withTimeoutOrNull

ì˜ˆì™¸ ëŒ€ì‹  nullì„ ë°˜í™˜

```kotlin
suspend fun fetchUser(): User {
    // ì˜ì›íˆ ì‹¤í–‰ë¨
    while(true) {
        yield()
    }
}

suspend fun getUserOrNull(): User? = 
    withTimeoutOrNull(5000) { // ì‘ë‹µì´ 5ì´ˆ ì´ˆê³¼ë¡œ ê¸°ë‹¤ë¦¬ë©´ Null ë°˜í™˜
        fetchUser()
    }
    
suspend fun main() = coroutineScope {
    val user = getUserOrNull()
    println("User: $user")
}
```

## ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜ ì—°ê²°í•˜ê¸°

ì„œë¡œ ë‹¤ë¥¸ ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜ì˜ ê¸°ëŠ¥ì´ í•„ìš”í•  ë•Œ, ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜ì—ì„œ ë‹¤ë¥¸ ê¸°ëŠ¥ì„ ê°€ì§„ ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´ ëœë‹¤!

```kotlin
suspend fun calculateAnswerOrNull(): User? = 
    withContext(Dispatchers.Default) {
        withTimeoutOrNull(1000) {
            calculateAnswer()
        }
    }
```

## ì¶”ê°€ì ì¸ ì—°ì‚°&#x20;

ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë„ì¤‘ì— ì¶”ê°€ì ì¸ ì—°ì‚°ì„ ìˆ˜í–‰í•˜ëŠ” ê²½ìš°, ë™ì¼ ìŠ¤ì½”í”„ì—ì„œ launchë¥¼ í˜¸ì¶œí•˜ëŠ” ë°©ë²•ì´ ìì£¼ ì‚¬ìš©ëœë‹¤

ì˜ˆ) ì‚¬ìš©ì í”„ë¡œí•„ì„ ë³´ì—¬ì¤€ ë‹¤ìŒ, ë¶„ì„ì„ ìœ„í•œ ëª©ì ìœ¼ë¡œ ìš”ì²­ì„ ë³´ë‚´ê³  ì‹¶ë‹¤ë©´?

#### ì˜ëª»ëœ ë°©ë²•!

* coroutineScopeê°€ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ë³´ì—¬ì¤€ í›„, launch ë¡œ ì‹œì‘ëœ ì½”ë£¨í‹´ì´ ëë‚˜ê¸°ë¥¼ ê¸°ë‹¤ë ¤ì•¼ í•œë‹¤
* getProfileì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´, getNameê³¼ getFriends ìš”ì²­ë„ ì·¨ì†Œë˜ì–´ì•¼ í•˜ì§€ë§Œ, ë¶„ì„ì„ ìœ„í•œ í˜¸ì¶œì´ ì‹¤íŒ¨í–ˆë‹¤ê³  ì „ì²´ ê³¼ì •ì´ ì·¨ì†Œë˜ëŠ” ê±´ ì›í•˜ì§€ ì•ŠëŠ” ë™ì‘

```kotlin
class ShowUserDataUseCase(
    private val repo: UserDataRepository,
    private val view: UserDataView
) {
    suspend fun showUserData() = coroutineScope {
        val name = async { repo.getName() }
        val friends = async { repo.getFriends() }
        val profile = async { repo.getProfile() }
        val user = User(
            name = name.await(),
            friends = friends.await(),
            profile = profile.await()
        )
        
        view.show(user)
        launch { repo.notifyProfileShown() } // ?ë¶„ì„?
    }
}

fun onCreate() {
    viewModelScope.launch {
        _progressBar.value = true
        showUserData()
        _progressBar.value = false
    }
}
```

#### ë˜ ë‹¤ë¥¸ ìŠ¤ì½”í”„ì—ì„œ ë‹¤ë¥¸ ë™ì‘ì„ ì‹œì‘í•˜ì

* ìƒì„±ìë¥¼ í†µí•´ ì£¼ì…í•˜ë©´ ìœ ë‹› í…ŒìŠ¤íŠ¸ë„ ì¶”ê°€í•  ìˆ˜ ìˆê³ , ìŠ¤ì½”í”„ë¥¼ ì‚¬ìš©í•˜ëŠ”ë°ë„ ìš©ì´
* ì¤‘ë‹¨ í•¨ìˆ˜ëŠ” ì£¼ì…ëœ ìŠ¤ì½”í”„ì—ì„œ ì‹œì‘í•œ ì—°ì‚°ì´ ëë‚  ë•Œ ê¹Œì§€ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ (ë³„ë„ì˜ ë¶€ëª¨-ìì‹ ê´€ê³„ë¥¼ ê°€ì§€ë‹ˆê¹Œ?)

ğŸ¤” ìŠ¤ì½”í”„ë¥¼ ì¸ìë¡œ ë„˜ê¸°ì§€ ë§ë¼ê³  ìœ„ì— ë˜ì–´ ìˆì—ˆëŠ”ë°

* ë¶€ëª¨ ì—­í• ì„ í•  ìŠ¤ì½”í”„ë¥¼ ì¸ìë¡œ ë„˜ê¸°ì§€ ë§ë¼ëŠ” ê±´ê°€? í 

```kotlin
val analyticsScope = CoroutineScope(SupervisorJob())

class ShowUserDataUseCase(
    private val repo: UserDataRepository,
    private val view: UserDataView,
    private val analyticsScope: CoroutineScope // ìƒì„±ìë¥¼ í†µí•´ì„œ ì£¼ì…
) {
    suspend fun showUserData = coroutineScope {
        val name = async { repo.getName() }
        val friends = async { repo.getFriends() }
        val profile = async { repo.getProfile() }
        val user = User(
            name = name.await(),
            friends = friends.await(),
            profile = profile.await()
        )
        
        view.show(user)
        analyticsScope.launch { repo.notifyProfileShown() } // ì£¼ì…ëœ ìŠ¤ì½”í”„ì—ì„œ ì¶”ê°€ì  ì—°ì‚° ì‹œì‘
    }
}
```
