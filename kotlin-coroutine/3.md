# 3장 중단은 어떻게 동작할까?

## 중단

* 실행을 중간에 멈추고, 멈춘 지점부터 다시 실행한다
* 코루틴은 중단되었을 때 Contnuation 객체를 반환 > Continuation를 이용해서 멈췄던 곳에서 다시 코루틴을 실행할 수 있다

### 중단 함수 suspend function

* **코루틴을 중단할 수 있는 함수**
* 반드시 코루틴 또는 다른 중단 함수에 의해 호출되어야 함

## 재개

* 작업을 재개하려면 코루틴이 필요 (runBlocking, luanch 와 같은 코루틴 빌더로 생성 가능)
* suspendCoroutine
  * 중단되기 전에 Continuation 객체를 사용할 수 있음
  * 내부의 람다 함수는 중단되기 전에 실행됨
    * Continuation 객체를 저장한 뒤, 코루틴을 다시 실행할 시점을 결정하기 위해 사용함
* resume
  * 코루틴을 다시 시작
  * 간혹 코드 최적화로 인해 곧바로 코루틴이 재개되는 경우, 아예 중단되지 않는 경우도 있음

```kotlin
suspend fun main() {
    println("BEFORE")
    
    suspendCoroutine<Unit> { continuation -> // Continuation 객체
        println("BEFORE TOO")
        continuation.resume(Unit) // 중단 후 곧바로 실행
    }
    
    println("AFTER")
}

inline fun <T> Continuation<T>.resume(value: T): Unit = 
    resumeWith(Result.success(value))
    
inline fun <T> Continuation<T>.resumeWithException(exception: Throwable): Unit =
    resumeWith(Result.failure(exception))
```



### 잠시 정지했다가 재개

* 방법 1 - 1초 후 사라질 스레드 생성하기
  * 스레드 생성 비용이 아까움

```kotlin
fun continueAfterSecond(continuatin: Continuation<Unit>) {
    thread {
        Thread.sleep(1000)
        continuation.resume(Unit)
    }
}

suspend fun main() {
    println("BEFORE")
    
    suspendCoroutine<Unit> { continuation ->
        continueAfterSecond(continuation)
    }
    
    println("AFTER")
}
```

* 방법 2 - ScheduledExecutorServie 사용하기
  * 실제 코틀린 코루틴 라이브러리 delay 구현 로직과 비슷

```kotlin
private val executor =
    Executors.newSingleThreadScheduledExecutor {
        Thread(it, "scheduler").apply { isDaemon = true }
    }

suspend fun delay(timeMillis: Long): Unit = 
    suspendCoroutine { cont ->
        executor.schedule({
            continuation.resume(Unit)
        }, timeMillis, TimeUnit.MILLISECONDS)
    }
            
suspend fun main() {
    println("BEFORE")
    
    delay(1000)
    
    println("AFTER")
}
```



## 값으로 재개하기 - resume

* resume 함수에 왜 Unit 을 인자로 넘길까? -> Unit : 함수의 리턴타입이자 Continuation의 제네릭 타입 인자라서

```kotlin
val ret: Unit =
    suspendCoroutine<Unit> { cont: Continuation<Unit> ->
        cont.resume(Unit)
    }
```

* suspendCoroutine을 호출할 때 Continuation 객체로 반환될 값의 타입을 지정한 경우, resume을 통해 반환되는 값은 반드시 지정된 타입과 같은 타입이어야 한다

```kotlin
val i: Int = suspendCoroutin<Int> { cont ->
    cont.resume(42)
}
```



## 예외로 재개하기 - resumeWithException





## 함수가 아닌 코루틴을 중단시킨다!

중단 함수 자체가 코루틴인게 아니고, 코루틴을 중단할 수 있는 함수!

